<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Groq Voice Assistant</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(to right, #141e30, #243b55);
      color: white;
      margin: 0;
      display: flex;
      height: 100vh;
    }
    /* Sidebar */
    #sidebar {
      width: 250px;
      flex-shrink: 0;
      background: #1c2533;
      padding: 15px;
      display: flex;
      flex-direction: column;
      border-right: 2px solid #2e3b4e;
    }
    #sidebar h2 { font-size: 18px; margin-bottom: 12px; }
    .sidebar-btn {
      background: #2e3b4e;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 10px;
      margin: 4px 0;
      cursor: pointer;
      text-align: left;
      font-size: 14px;
    }
    .sidebar-btn:hover { background: #3c4b63; }
    #chatList { margin-top: 10px; flex-grow: 1; overflow-y: auto; }
    /* Chat list items */
    .chat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #2e3b4e;
      margin: 6px 0;
      padding: 8px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }
    .chat-item span { flex-grow: 1; }
    /* Menu */
    .message-menu { position: relative; }
    .menu-btn {
      background: none;
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
      padding: 0 6px;
    }
    .menu-options {
      display: none;
      position: absolute;
      right: 0;
      top: 20px;
      background: #2c2c2c;
      min-width: 120px;
      border-radius: 8px;
      box-shadow: 0px 2px 8px rgba(0,0,0,0.3);
      z-index: 10;
    }
    .menu-options button {
      width: 100%;
      background: none;
      border: none;
      color: white;
      text-align: left;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 14px;
    }
    .menu-options button:hover { background: #444; }
    /* Main area */
    #main {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      overflow: hidden;
    }
    h1 { font-size: 24px; margin-bottom: 10px; text-align: center; }
    #chatbox {
      flex-grow: 1;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      overflow-y: auto;
    }
    .message {
      margin: 10px 0;
      padding: 10px;
      border-radius: 10px;
      max-width: 80%;
      word-wrap: break-word;
    }
    .user { background: #4cafef; color: white; text-align: right; margin-left: auto; }
    .ai   { background: #2ecc71; color: white; text-align: left; margin-right: auto; }
    #controls {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }
    input {
      padding: 10px;
      border-radius: 8px;
      border: none;
      flex: 1;
      min-width: 160px;
      font-size: 16px;
    }
    button {
      padding: 10px 15px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: #ff9800;
      color: white;
      font-size: 16px;
    }
    button:hover { background: #e68900; }
    .thinking { opacity: 0.85; font-style: italic; }
    .read-btn {
      margin-top: 6px;
      background: #1976d2;
      font-size: 14px;
      padding: 6px 10px;
    }
    .stop-btn { background: #d32f2f; }
    .stop-btn:hover { background: #b71c1c; }
    /* --- List formatting inside AI messages --- */
    .ai ol, .ai ul { margin-left: 20px; }
    .ai li { margin: 4px 0; }
    /* Mobile adjustments */
    @media (max-width: 768px) {
      body { flex-direction: column; }
      #sidebar {
        width: 100%;
        height: 180px;
        flex-direction: row;
        overflow-x: auto;
        border-right: none;
        border-bottom: 2px solid #2e3b4e;
      }
      #main { flex-grow: 1; height: calc(100vh - 180px); }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div id="sidebar">
    <div style="flex:1; display:flex; flex-direction:column;">
      <h2>Chats</h2>
      <button class="sidebar-btn" onclick="newChat()">‚ûï New Chat</button>
      <input type="text" id="searchInput" placeholder="üîç Search chats"
             style="margin-top:10px; padding:6px; border-radius:6px; border:none; width:100%;">
      <div id="chatList"></div>
    </div>
  </div>

  <!-- Main -->
  <div id="main">
    <h1>üé§ Groq Voice Assistant</h1>
    <div id="chatbox"><p><em>ü§ñ Hello! I am your AI assistant. Ask me anything.</em></p></div>

    <form id="chatForm" onsubmit="return handleSubmit(event)">
      <div id="controls">
        <input type="text" id="userInput" placeholder="Type your question..." autocomplete="off" />
        <select id="voiceSelect"></select>
        <button id="askBtn" type="submit">Ask</button>
        <button type="button" onclick="startVoiceInput()">üéôÔ∏è Speak</button>
        <button type="button" onclick="stopSpeech()" class="stop-btn">üîá Stop</button>
      </div>
    </form>
  </div>

  <script>
    const userInput = document.getElementById("userInput");
    const chatbox = document.getElementById("chatbox");
    const askBtn = document.getElementById("askBtn");
    const chatList = document.getElementById("chatList");
    const searchInput = document.getElementById("searchInput");
    const voiceSelect = document.getElementById("voiceSelect");

    let chats = JSON.parse(localStorage.getItem("chats") || "[]");
    let currentChatId = null;
    let voices = [];

    // Load voices for speech
    function loadVoices() {
      voices = speechSynthesis.getVoices();
      voiceSelect.innerHTML = "";
      voices.forEach((voice, i) => {
        const option = document.createElement("option");
        option.value = i;
        option.textContent = `${voice.name} (${voice.lang})`;
        voiceSelect.appendChild(option);
      });
    }
    speechSynthesis.onvoiceschanged = loadVoices;

    function handleSubmit(e) {
      e.preventDefault();
      askAI();
      return false;
    }

    async function askAI() {
      const userMessage = userInput.value.trim();
      if (!userMessage) return;

      addMessage(userMessage, "user");
      userInput.value = "";
      userInput.focus();
      saveMessage(currentChatId, { sender: "user", text: userMessage });

      askBtn.disabled = true;
      const thinkingEl = addMessage("Thinking‚Ä¶", "ai");
      thinkingEl.classList.add("thinking");

      try {
        const res = await fetch("/ask", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ message: userMessage })
        });
        const data = await res.json();

        thinkingEl.innerHTML = "ü§ñ " + formatMessage(data.response || "‚ö†Ô∏è No response");
        thinkingEl.classList.remove("thinking");

        saveMessage(currentChatId, { sender: "ai", text: data.response });

        if (data.response) {
          const readBtn = document.createElement("button");
          readBtn.textContent = "Read full answer üîä";
          readBtn.className = "read-btn";
          readBtn.onclick = () => speakText(data.response, true);
          thinkingEl.appendChild(document.createElement("br"));
          thinkingEl.appendChild(readBtn);

          const overview = generateOverview(data.response);
          speakText(overview, false);
        }
      } catch (err) {
        thinkingEl.textContent = "ü§ñ ‚ö†Ô∏è Error: " + err;
        thinkingEl.classList.remove("thinking");
      } finally {
        askBtn.disabled = false;
      }
    }

    // --- format AI response for lists ---
    function formatMessage(text) {
      if (!text) return "";
      return text.replace(/\n/g, "<br>");
    }

    function speakText(text, isFull) {
      stopSpeech();
      const speech = new SpeechSynthesisUtterance(text);
      const selected = voices[voiceSelect.value] || voices[0];
      speech.voice = selected;
      speech.lang = selected?.lang || "en-US";
      speech.rate = isFull ? 1.05 : 1.15;
      window.speechSynthesis.speak(speech);
    }

    function stopSpeech() {
      try { window.speechSynthesis.cancel(); } catch (_) {}
    }

    function generateOverview(text) {
      const words = text.split(" ");
      if (words.length <= 40) return text;
      return words.slice(0, 40).join(" ") + "... This was a quick summary.";
    }

    function startVoiceInput() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) {
        addMessage("Speech Recognition not supported.", "ai");
        return;
      }
      const recognition = new SR();
      recognition.lang = "en-US";
      recognition.start();
      recognition.onresult = e => {
        userInput.value = e.results[0][0].transcript;
        askAI();
      };
    }

    function addMessage(text, sender) {
      const msg = document.createElement("div");
      msg.className = "message " + sender;
      msg.innerHTML = (sender === "ai" ? "ü§ñ " + formatMessage(text) : "üßë " + text);
      chatbox.appendChild(msg);
      chatbox.scrollTop = chatbox.scrollHeight;
      return msg;
    }

    // --- Chats management ---
    function newChat() {
      const newId = Date.now();
      currentChatId = newId;
      chats.push({ id: newId, title: "New Chat", messages: [] });
      saveChats();
      renderChatList();
      loadChat(newId);
    }

    function saveMessage(chatId, message) {
      const chat = chats.find(c => c.id === chatId);
      if (!chat) return;
      chat.messages.push(message);
      if (chat.messages.length === 1 && message.sender === "user") {
        chat.title = message.text.slice(0, 20) + (message.text.length > 20 ? "..." : "");
      }
      saveChats();
      renderChatList();
    }

    function loadChat(chatId) {
      currentChatId = chatId;
      chatbox.innerHTML = "";
      const chat = chats.find(c => c.id === chatId);
      if (!chat) return;
      chat.messages.forEach(m => addMessage(m.text, m.sender));
    }

    function saveChats() {
      localStorage.setItem("chats", JSON.stringify(chats));
    }

    function renderChatList() {
      chatList.innerHTML = "";
      chats.forEach(chat => {
        const chatItem = document.createElement("div");
        chatItem.className = "chat-item";
        const chatName = document.createElement("span");
        chatName.textContent = chat.title;
        chatItem.onclick = () => loadChat(chat.id);

        const menuContainer = document.createElement("div");
        menuContainer.className = "message-menu";
        const menuBtn = document.createElement("button");
        menuBtn.className = "menu-btn";
        menuBtn.textContent = "‚ãÆ";
        const menuOptions = document.createElement("div");
        menuOptions.className = "menu-options";
        ["Share", "Rename", "Archive", "Delete"].forEach(option => {
          const optBtn = document.createElement("button");
          optBtn.textContent = option;
          optBtn.onclick = e => {
            e.stopPropagation();
            handleMenuAction(option, chat, chatItem, chatName);
            menuOptions.style.display = "none";
          };
          menuOptions.appendChild(optBtn);
        });
        menuContainer.appendChild(menuBtn);
        menuContainer.appendChild(menuOptions);
        chatItem.appendChild(chatName);
        chatItem.appendChild(menuContainer);
        chatList.appendChild(chatItem);

        menuBtn.onclick = e => {
          e.stopPropagation();
          menuOptions.style.display = menuOptions.style.display === "block" ? "none" : "block";
        };
      });
    }

    function handleMenuAction(action, chat, chatItem, chatName) {
      switch(action) {
        case "Share":
          navigator.clipboard.writeText(JSON.stringify(chat.messages, null, 2));
          alert("Chat copied to clipboard!");
          break;
        case "Rename":
          const newText = prompt("Enter new name:", chat.title);
          if (newText) { chat.title = newText; saveChats(); renderChatList(); }
          break;
        case "Archive":
          chatItem.style.opacity = "0.5";
          alert("Chat archived!");
          break;
        case "Delete":
          chats = chats.filter(c => c.id !== chat.id);
          saveChats();
          renderChatList();
          chatbox.innerHTML = "";
          break;
      }
    }

    // --- Search filter ---
    searchInput.addEventListener("input", () => {
      const q = searchInput.value.toLowerCase();
      document.querySelectorAll(".chat-item span").forEach(span => {
        const item = span.parentElement;
        item.style.display = span.textContent.toLowerCase().includes(q) ? "flex" : "none";
      });
    });

    // Load chats on start
    renderChatList();
    if (chats.length) loadChat(chats[chats.length-1].id);
    else newChat();
  </script>
</body>
</html>
